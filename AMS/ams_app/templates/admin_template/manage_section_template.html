{% extends 'admin_template/base_template.html' %}

{% block page_title %}
Manage Sections
{% endblock page_title %}

{% block main_content %}
<section class="content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow-lg border-0 rounded">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <a href="{% url 'add_section' %}" class="btn btn-success btn-sm rounded-pill px-3">+ Section</a>

            <div class="input-group input-group-sm w-25">
              <input type="text" name="table_search" id="searchBox" class="form-control rounded" placeholder="Search section..." onkeyup="searchTable()">
              <button type="button" class="btn btn-light"><i class="fas fa-search"></i></button>
            </div>
          </div>

          <div class="card-body table-responsive p-0">
            <table class="table table-hover text-center" id="sectionTable">
              <thead class="bg-dark text-white sticky-header">
                <tr>
                  <th>Section Name</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for section in sections %}
                <tr>
                  <td>{{ section.section_name }}</td>
                  <td>
                    <a href="/edit_section/{{ section.id }}" class="btn btn-success btn-sm">
                      <i class="fas fa-edit"></i> Edit
                    </a>
                    <!-- Delete button triggers modal -->
                    <button class="btn btn-danger btn-sm" onclick="openDeleteModal({{ section.id }})">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <!-- Pagination Controls -->
            <div class="d-flex justify-content-center my-3">
              <button class="btn btn-outline-primary btn-sm me-2" onclick="paginate(-1)">Previous</button>
              <span class="align-self-center" id="pageNumber">Page 1</span>
              <button class="btn btn-outline-primary btn-sm ms-2" onclick="paginate(1)">Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this section? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Yes, Delete</a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  let currentPage = 1;
  const rowsPerPage = 5;

  // For pagination + search compatibility
  function getFilteredRows() {
    const filter = document.getElementById('searchBox').value.toLowerCase();
    const rows = Array.from(document.querySelectorAll('#sectionTable tbody tr'));
    return rows.filter(row => {
      const text = row.cells[0].textContent.toLowerCase();
      return text.includes(filter);
    });
  }

  function searchTable() {
    currentPage = 1;
    updateTable();
  }

  function paginate(direction) {
    const filteredRows = getFilteredRows();
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    currentPage += direction;
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages) currentPage = totalPages;
    updateTable();
  }

  function updateTable() {
    const filteredRows = getFilteredRows();
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    // Hide all first
    document.querySelectorAll('#sectionTable tbody tr').forEach(row => row.style.display = 'none');

    // Show only paginated & filtered rows
    filteredRows.slice(start, end).forEach(row => row.style.display = '');

    // Update page number display
    document.getElementById('pageNumber').textContent = `Page ${totalPages === 0 ? 0 : currentPage} of ${totalPages}`;

    // Disable Prev/Next buttons when needed
    document.querySelector('button[onclick="paginate(-1)"]').disabled = currentPage <= 1;
    document.querySelector('button[onclick="paginate(1)"]').disabled = currentPage >= totalPages;
  }

  // Initial render
  document.addEventListener('DOMContentLoaded', () => {
    updateTable();
  });

  // Delete modal logic
  function openDeleteModal(sectionId) {
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.href = `/delete_section/${sectionId}`;
    deleteModal.show();
  }
</script>

<style>
  /* Styling */
  .table th, .table td {
    vertical-align: middle;
  }
  .table th {
    text-align: center;
  }
  .table td {
    text-align: center;
  }
  .btn-sm {
    transition: all 0.2s ease-in-out;
  }
  .btn-sm:hover {
    transform: scale(1.05);
  }
</style>
{% endblock main_content %}
