{% extends 'admin_template/base_template.html' %}

{% block page_title %}
RFID Attendance
{% endblock page_title %}

{% block main_content %}
<div class="container-fluid">
    <div class="row">
        <!-- Fixed Message -->
        <div class="col-12 text-center mb-3">
            <h3 id="fixedMessage">⏳ Waiting for RFID tag...</h3>
        </div>

        <div>
            <h2>Last Detected Tag:</h2>
            <p id="lastTag">None</p>
            <p id="fixedMessage">Waiting for tag...</p>
        
            <h3>Tag History</h3>
            <ul class="list-group" id="tagHistory"></ul>
        </div>
    </div>
</div>

<style>
    #tagHistory {
        max-height: 510px;
        max-width: 650px;
        overflow-y: auto;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 15px;
        margin-top: 80px;
    }
    .list-group-item {
        margin: 2px 0;
    }
    #title {
        margin-top: 0;
        padding: 5px;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
    }
</style>
<script>
    let lastFetchedTag = "";  // Track the last fetched tag

    async function fetchDetectedUsername() {
        try {
            const response = await fetch('/api/rfid_username/');
            const data = await response.json();

            if (response.ok) {
                const tagText = `${data.username} (${data.rfid})`;

                // Print only if the new tag is different from the last fetched tag
                if (data.rfid !== lastFetchedTag) {
                    lastFetchedTag = data.rfid;

                    const lastTagElement = document.getElementById('lastTag');
                    const tagHistory = document.getElementById('tagHistory');
                    const fixedMessage = document.getElementById('fixedMessage');

                    lastTagElement.innerText = tagText;

                    const newItem = document.createElement('li');
                    newItem.classList.add('list-group-item');
                    newItem.innerText = tagText;
                    tagHistory.prepend(newItem);

                    fixedMessage.innerText = '✅ Tag detected successfully.';

                    // Limit the history to 5 items
                    if (tagHistory.childElementCount > 5) {
                        tagHistory.removeChild(tagHistory.lastChild);
                    }
                }
            } else {
                console.error('Error fetching username:', data.error);
            }
        } catch (error) {
            console.error('Error fetching detected username:', error);
        }
    }

    // Fetch username once per new detection
    setInterval(fetchDetectedUsername, 1000);
</script>

{% endblock main_content %}
